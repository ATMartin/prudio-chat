/*! JS slack-chat 2014-10-14 */
!function(){function a(){c=window.jQuery.noConflict(!0),b()}function b(){c(document).ready(function(a){a.urlParam=function(a,b){var c=new RegExp("[?|&|#]"+a+"=([^&;]+?)(&|#|;|$)").exec(b);return c[1]||0},a.loadCSS=function(b){var c=a("<link rel='stylesheet' type='text/css' href='"+b+"'>");a("head").append(c)},a.findJS=function(){for(var a=document.getElementsByTagName("script"),b=/.*slack-chat\.js/,c=0;c<a.length;c++)if(a[c].src.match(b))return a[c];throw"Could not find the script from Oghma."},a.getSettings=function(){for(var b=a.findJS(),c=["token"],d=new Object,e=0;e<c.length;e++){var f=c[e];d[f]=a.urlParam(f,b.src)}if("undefined"!=typeof window._LBSettings)for(var g in window._LBSettings)d[g]=window._LBSettings[g];return d},a.createButton=function(){var b=a('<div id="oghma-button" title="Chat with us"></div>');a("body").append(b)},a.loadJS=function(b){var c=a("<script src='"+b+"'></script>");a("head").append(c)},a.scrollChat=function(b){a(b).animate({scrollTop:a(b).height()},"slow")},a.setCookie=function(a,b,c){c=c||730;var d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3),document.cookie=a+"="+b+"; expires="+d.toGMTString()+"; path=/"},a.getCookie=function(a){var b=" "+document.cookie,c=b.indexOf(" "+a+"=");if(-1==c)b=null;else{c=b.indexOf("=",c)+1;var d=b.indexOf(";",c);-1==d&&(d=b.length),b=unescape(b.substring(c,d))}return b},a.getUUID=function(){var b="oghma-uuid";if(null===a.getCookie(b)){a.loadJS(d+"/js/uuid.js");var c=uuid.v4();return a.setCookie(b,c),c}return a.getCookie(b)},a.getUserSystemInfo=function(){var a="-",b="";screen.width&&(width=screen.width?screen.width:"",height=screen.height?screen.height:"",b+=""+width+" x "+height);var c,d,e,f=navigator.appVersion,g=navigator.userAgent,h=navigator.appName,i=""+parseFloat(navigator.appVersion),j=parseInt(navigator.appVersion,10);-1!=(d=g.indexOf("Opera"))?(h="Opera",i=g.substring(d+6),-1!=(d=g.indexOf("Version"))&&(i=g.substring(d+8))):-1!=(d=g.indexOf("MSIE"))?(h="Microsoft Internet Explorer",i=g.substring(d+5)):-1!=(d=g.indexOf("Chrome"))?(h="Chrome",i=g.substring(d+7)):-1!=(d=g.indexOf("Safari"))?(h="Safari",i=g.substring(d+7),-1!=(d=g.indexOf("Version"))&&(i=g.substring(d+8))):-1!=(d=g.indexOf("Firefox"))?(h="Firefox",i=g.substring(d+8)):-1!=g.indexOf("Trident/")?(h="Microsoft Internet Explorer",i=g.substring(g.indexOf("rv:")+3)):(c=g.lastIndexOf(" ")+1)<(d=g.lastIndexOf("/"))&&(h=g.substring(c,d),i=g.substring(d+1),h.toLowerCase()==h.toUpperCase()&&(h=navigator.appName)),-1!=(e=i.indexOf(";"))&&(i=i.substring(0,e)),-1!=(e=i.indexOf(" "))&&(i=i.substring(0,e)),-1!=(e=i.indexOf(")"))&&(i=i.substring(0,e)),j=parseInt(""+i,10),isNaN(j)&&(i=""+parseFloat(navigator.appVersion),j=parseInt(navigator.appVersion,10));var k=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(f),l=navigator.cookieEnabled?!0:!1;"undefined"!=typeof navigator.cookieEnabled||l||(document.cookie="testcookie",l=-1!=document.cookie.indexOf("testcookie")?!0:!1);var m=a,n=[{s:"Windows 3.11",r:/Win16/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows ME",r:/Windows ME/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var o in n){var p=n[o];if(p.r.test(g)){m=p.s;break}}var q=a;switch(/Windows/.test(m)&&(q=/Windows (.*)/.exec(m)[1],m="Windows"),m){case"Mac OS X":q=/Mac OS X (10[\.\_\d]+)/.exec(g)[1];break;case"Android":q=/Android ([\.\_\d]+)/.exec(g)[1];break;case"iOS":q=/OS (\d+)_(\d+)_?(\d+)?/.exec(f),q=q[1]+"."+q[2]+"."+(0|q[3])}var r={screen:b,browser:h,browserVersion:i,mobile:k,os:m,osVersion:q,cookies:l};return r},a.loadCSS(d+"/slack-chat.css"),a.loadJS(d+"/socket.io/socket.io.js"),a.createButton(),a("#oghma-button").click(function(){var b=a.getSettings(),c=(document.getElementById("messageField"),document.getElementById("conversation"),13),e=a.getCookie("oghma-channel"),f=a.getCookie("oghma-signature"),g=a.getUserSystemInfo();a.ajax({url:d+"/chat/create",method:"POST",data:{token:b.token,channel:e,signature:f,userInfo:g},success:function(e){console.log(e),a.setCookie("oghma-channel",e.channel),a.setCookie("oghma-signature",e.signature);var f=io.connect(d+"/chat"),g=['<nav class="cbp-spmenu cbp-spmenu-vertical cbp-spmenu-right" id="cbp-spmenu-s2">',"       <h3>Chat</h3>","       <ul></ul>",'       <input type="text" name="message">',"   </nav>"].join("");a("body").append(g),a.scrollChat("#cbp-spmenu-s2 ul"),a("#cbp-spmenu-s2").toggleClass("cbp-spmenu-open"),a("#cbp-spmenu-s2 input").bind("keypress",function(b){if(b.keyCode==c&&""!=a(this).val()){var d=a(this).val();f.emit("noncryptSend",{message:d}),console.log("SEND: "+d),a("#cbp-spmenu-s2 ul").append('<li class="self">'+d+"</li>"),a.scrollChat("#cbp-spmenu-s2 ul"),a(this).val("")}}),f.on("connect",function(){console.log("Connected to "+e.channel),f.emit("joinRoom",b.token,e.channel,e.signature)}),f.on("noncryptMessage",function(b){"Other"==b.sender&&(a("#cbp-spmenu-s2 ul").append('<li class="other">'+b.message+"</li>"),a.scrollChat("#cbp-spmenu-s2 ul"))}),f.on("serverMessage",function(b){a("#cbp-spmenu-s2 ul").append("<li><i>Server: "+b.message+"</i></li>"),a.scrollChat("#cbp-spmenu-s2 ul")})}})})})}var c,d="http://oghma.herokuapp.com";if("localhost"==window.location.hostname&&(d="http://localhost:8888"),void 0===window.jQuery||"2.1.1"!==window.jQuery.fn.jquery){var e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src","//code.jquery.com/jquery-2.1.1.min.js"),e.readyState?e.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&a()}:e.onload=a,(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}else c=window.jQuery,b()}();